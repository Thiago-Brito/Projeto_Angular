<p-card>
    <p-toast></p-toast>

    <div class="flex justify-between items-center mb-5">
        <h1 class="text-2xl font-bold">{{ titulo }}</h1>
        <p-button label="Voltar" icon="pi pi-arrow-left" severity="secondary" routerLink="/clientes"></p-button>
    </div>

    <p-tabs *ngIf="isAlteracao" [(value)]="activeTab">
        <p-tablist>
            <p-tab value="0">Dados Pessoais</p-tab>
            <p-tab value="1">Visitas</p-tab>
        </p-tablist>

        <p-tabpanels>
            <p-tabpanel value="0">
                <ng-container *ngTemplateOutlet="formCliente"></ng-container>
            </p-tabpanel>

            <p-tabpanel value="1">
                <div class="flex gap-2 mb-3">
                    <p-button label="Nova Venda" icon="pi pi-shopping-cart" (onClick)="abrirDialogVenda()"></p-button>
                    <p-button label="Entrega / Devolução" icon="pi pi-truck" severity="info"
                        (onClick)="abrirDialogEstoque()"></p-button>
                    <p-button label="Detalhes do Estoque" icon="pi pi-box" severity="secondary"
                        (onClick)="abrirDialogEstoqueCliente()"></p-button>
                </div>
                <p-table [value]="visitasRows" [loading]="loadingVisitas" [paginator]="true" [rows]="10"
                    [responsiveLayout]="'scroll'">
                    <ng-template pTemplate="header">
                        <tr>
                            <th class="w-12rem">Data</th>
                            <th class="w-10rem">Tipo</th>
                            <th class="text-center!">Produtos distintos</th>
                            <th class="text-center!">Status pagamento</th>
                            <th class="text-center!">Ação</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-r>
                        <tr>
                            <td (click)="abrirDetalhe(r)" class="cursor-pointer">{{ formatData(r.dataVisita) }}</td>
                            <td (click)="abrirDetalhe(r)" class="cursor-pointer">{{ r.tipo || '-' }}</td>
                            <td (click)="abrirDetalhe(r)" class="cursor-pointer text-center!">{{ r.qtdProdutosDistintos }}</td>
                            <td class="text-center!">{{ r.statusPagamento || '-' }}</td>
                            <td class="text-center!">
                                <button pButton label="Pagar" icon="pi pi-credit-card" class="p-button-text"
                                    (click)="abrirDialogPagamento(r)"
                                    [disabled]="r.tipoVisita !== 'VENDA' || r.statusPagamento === 'Pago'"></button>
                                <button pButton icon="pi pi-print" class="p-button-text"
                                    (click)="imprimirVisita(r.id)"></button>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

                                <p-dialog [(visible)]="dialogPagamentoAberto" [modal]="true"
                    [breakpoints]="{ '1199px': '50vw', '575px': '90vw' }"
                    header="Pagamento" [maximizable]="true">
                    <form [formGroup]="pagamentoForm" class="grid gap-3 min-h-fit">
                        <div>
                            <label class="block mb-1">Valor pago agora</label>
                            <input
                                pInputText
                                type="text"
                                inputmode="numeric"
                                placeholder="Ex. 10,00"
                                [value]="pagamentoDisplay"
                                (input)="onPagamentoInput($event)"
                                (blur)="onPagamentoBlur()"
                                class="w-full" />
                        </div>

                        <div class="text-sm text-gray-600">
                            <div>Total: {{ vendaSelecionada?.totalPagar | currency:'BRL':'symbol':'1.2-2' }}</div>
                            <div>Pago: {{ vendaSelecionada?.valorPago | currency:'BRL':'symbol':'1.2-2' }}</div>
                            <div>Falta: {{ (vendaSelecionada?.totalPagar || 0) - (vendaSelecionada?.valorPago || 0) | currency:'BRL':'symbol':'1.2-2' }}</div>
                        </div>

                        <div class="flex justify-self-start gap-2 mt-4">
                            <p-button severity="info" label="Usar restante" icon="pi pi-wallet" class="p-button-text"
                                [disabled]="(vendaSelecionada?.totalPagar || 0) - (vendaSelecionada?.valorPago || 0) <= 0"
                                (onClick)="preencherPagamentoRestante()"></p-button>
                            <p-button severity="secondary" label="Cancelar" class="p-button-text"
                                (onClick)="fecharDialogPagamento()"></p-button>
                            <p-button severity="success" label="Salvar" icon="pi pi-check"
                                [disabled]="pagamentoForm.invalid" (onClick)="salvarPagamento()"></p-button>
                        </div>
                    </form>
                </p-dialog>

<p-dialog [(visible)]="dialogVendaAberto" [modal]="true"
                    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [header]="tituloDialogVenda"
                    [maximizable]="true">
                    <form [formGroup]="visitasForm" class="grid gap-3 min-h-fit">
                        <div>
                            <label class="block mb-1">Data da visita</label>
                            <p-datepicker formControlName="data" dateFormat="dd/mm/yy" [showIcon]="true"></p-datepicker>
                        </div>

                        <div>
                            <label class="block mb-1">Observações</label>
                            <textarea class="w-150 resize-none" pInputTextarea rows="3"
                                formControlName="observacoes"></textarea>
                        </div>

                        <p-button severity="info" label="Adicionar produto" (onClick)="addItemVenda()" icon="pi pi-plus"
                            [disabled]="somenteLeitura"></p-button>

                        <div formArrayName="itens">
                            <p-table [value]="itens.controls" dataKey="id">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th class="w-1px">Produto</th>
                                        <th class="w-1px text-center!">Estoque</th>
                                        <th class="w-1px text-center!">Estoque atual</th>
                                        <th class="w-1px text-center!">Quantidade vendida</th>
                                        <th class="w-1px">Preço</th>
                                        <th class="w-1px text-center!">Valor bruto</th>
                                        <th class="w-1px text-center!">Desconto</th>
                                        <th class="w-1px text-center!">A pagar</th>
                                        <th class="w-1px"></th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-row let-i="rowIndex">
                                    <tr [formGroupName]="i">
                                        <td>
                                            <p-select formControlName="produtoId" name="produto" [options]="produtos"
                                                optionLabel="nome" optionValue="id" [filter]="true" filterBy="nome"
                                                [showClear]="true" placeholder="Selecione um produto"
                                                panelStyleClass="top-auto! bottom-full! origin-bottom! -translate-y-11"
                                                appendTo="body">
                                                <ng-template pTemplate="selectedItem" let-selectedOption>
                                                    <div class="flex items-center gap-2">
                                                        <div>{{ selectedOption?.nome }}</div>
                                                    </div>
                                                </ng-template>
                                                <ng-template pTemplate="item" let-produto>
                                                    <div class="flex items-center gap-2">
                                                        <div>{{ produto.nome }}</div>
                                                    </div>
                                                </ng-template>
                                            </p-select>
                                        </td>

                                        <td class="text-center">
                                            <div class="flex justify-center">
                                                <input pInputText type="number" min="0" formControlName="possuia"
                                                    readonly class="text-center" style="width: 9ch;" />
                                            </div>
                                        </td>

                                        <td class="text-center">
                                            <div class="flex justify-center">
                                                <input pInputText type="number" min="0" formControlName="possuiAgora"
                                                    (input)="recalc(i)" class="text-center" style="width: 9ch;" />
                                            </div>
                                        </td>

                                        <td class="text-center">
                                            <div class="flex justify-center">
                                                <input pInputText type="number" min="0" formControlName="vendido"
                                                    readonly class="text-center" style="width: 9ch;" />
                                            </div>
                                        </td>

                                        <td class="text-center">
                                            {{getItem(i).get('preco')?.value | currency:'BRL':'symbol':'1.2-2'}}
                                        </td>

                                        <td class="text-center">
                                            {{getItem(i).get('valorBruto')?.value | currency:'BRL':'symbol':'1.2-2'}}
                                        </td>

                                        <td class="text-center">
                                            {{ getItem(i).get('desconto')?.value | currency:'BRL':'symbol':'1.2-2' }}
                                        </td>

                                        <td class="text-center">
                                            {{ getItem(i).get('valorPagar')?.value | currency:'BRL':'symbol':'1.2-2' }}
                                        </td>

                                        <td class="text-right">
                                            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger"
                                                type="button" (click)="removeItem(i)"
                                                [disabled]="somenteLeitura"></button>
                                        </td>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="footer">
                                    <tr>
                                        <td class="text-left font-medium">Totais</td>
                                        <td class="text-center!">{{ total('possuia') }}</td>
                                        <td class="text-center!">{{ total('possuiAgora') }}</td>
                                        <td class="text-center!">{{ total('vendido') }}</td>
                                        <td class="text-center!"></td>
                                        <td class="text-center!">{{ total('valorBruto') |
                                            currency:'BRL':'symbol':'1.2-2' }}</td>
                                        <td class="text-center!">{{ total('desconto') | currency:'BRL':'symbol':'1.2-2'
                                            }}</td>
                                        <td class="text-center!">{{ total('valorPagar') |
                                            currency:'BRL':'symbol':'1.2-2' }}</td>
                                        <td class="text-center!"></td>
                                    </tr>

                                </ng-template>
                            </p-table>
                        </div>

                        <div class="flex justify-self-start gap-2 mt-10">
                            <p-button severity="danger" label="Cancelar" class="p-button-text"
                                (onClick)="fecharDialogVenda()"></p-button>
                            <p-button severity="success" label="Salvar" icon="pi pi-check"
                                [disabled]="somenteLeitura || visitasForm.invalid || itens.length === 0"
                                (onClick)="salvarVenda()"></p-button>
                        </div>
                    </form>
                </p-dialog>

                <p-dialog [(visible)]="dialogEstoqueAberto" [modal]="true"
                    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [header]="tituloDialogEstoque"
                    [maximizable]="true">
                    <form [formGroup]="visitasForm" class="grid gap-3 min-h-fit">
                        <div>
                            <label class="block mb-1">Data da visita</label>
                            <p-datepicker formControlName="data" dateFormat="dd/mm/yy" [showIcon]="true"></p-datepicker>
                        </div>

                        <div>
                            <label class="block mb-1">Observações</label>
                            <textarea class="w-150 resize-none" pInputTextarea rows="3"
                                formControlName="observacoes"></textarea>
                        </div>

                        <p-button severity="info" label="Adicionar produto" (onClick)="addItemEstoque()"
                            icon="pi pi-plus" [disabled]="somenteLeitura"></p-button>

                        <div formArrayName="itens">
                            <p-table [value]="itens.controls" dataKey="id">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th class="w-1px">Produto</th>
                                        <th class="w-1px text-center!">Estoque</th>
                                        <th class="w-1px text-center!">Entregue</th>
                                        <th class="w-1px text-center!">Retirado</th>
                                        <th class="w-1px text-center!">Estoque Atual</th>
                                        <th class="w-1px"></th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-row let-i="rowIndex">
                                    <tr [formGroupName]="i">
                                        <td>
                                            <p-select formControlName="produtoId" name="produto" [options]="produtos"
                                                optionLabel="nome" optionValue="id" [filter]="true" filterBy="nome"
                                                [showClear]="true" placeholder="Selecione um produto"
                                                panelStyleClass="top-auto! bottom-full! origin-bottom! -translate-y-11"
                                                appendTo="body">
                                                <ng-template pTemplate="selectedItem" let-selectedOption>
                                                    <div class="flex items-center gap-2">
                                                        <div>{{ selectedOption?.nome }}</div>
                                                    </div>
                                                </ng-template>
                                                <ng-template pTemplate="item" let-produto>
                                                    <div class="flex items-center gap-2">
                                                        <div>{{ produto.nome }}</div>
                                                    </div>
                                                </ng-template>
                                            </p-select>
                                        </td>

                                        <td><input pInputText type="number" min="0" formControlName="possuia"
                                                (input)="recalc(i)" class="text-center" style="width: 9ch;" />
                                        </td>
                                        <td><input pInputText type="number" min="0" formControlName="entregue"
                                                (input)="recalc(i)" class="text-center" style="width: 9ch;" />
                                        </td>
                                        <td><input pInputText type="number" min="0" formControlName="retirado"
                                                (input)="recalc(i)" class="text-center" style="width: 9ch;" />
                                        </td>

                                        <td class="flex justify-center">
                                            <input pInputText formControlName="possuiAgora" readonly
                                                class="items-center text-center" style="width: 9ch;" />
                                        </td>

                                        <td class="text-right">
                                            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger"
                                                type="button" (click)="removeItem(i)"
                                                [disabled]="somenteLeitura"></button>
                                        </td>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="footer">
                                    <tr>
                                        <td class="text-left font-medium">Totais</td>
                                        <td class="text-center!">{{ total('possuia') }}</td>
                                        <td class="text-center!">{{ total('entregue') }}</td>
                                        <td class="text-center!">{{ total('retirado') }}</td>
                                        <td class="text-center!">{{ total('possuiAgora') }}</td>
                                        <td class="text-center!"></td>
                                    </tr>

                                </ng-template>
                            </p-table>
                        </div>

                        <div class="flex justify-self-start gap-2 mt-10">
                            <p-button severity="danger" label="Cancelar" class="p-button-text"
                                (onClick)="fecharDialogEstoque()"></p-button>
                            <p-button severity="success" label="Salvar" icon="pi pi-check"
                                [disabled]="somenteLeitura || visitasForm.invalid || itens.length === 0"
                                (onClick)="salvarEstoque()"></p-button>
                        </div>
                    </form>
                </p-dialog>

                <p-dialog [(visible)]="dialogDetalheAberto" [modal]="true"
                    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [header]="tituloDialog" [maximizable]="true">
                    <form [formGroup]="visitasForm" class="grid gap-3 min-h-fit">
                        <div>
                            <label class="block mb-1">Data da visita</label>
                            <p-datepicker formControlName="data" dateFormat="dd/mm/yy" [showIcon]="true"></p-datepicker>
                        </div>

                        <div>
                            <label class="block mb-1">Observações</label>
                            <textarea class="w-150 resize-none" pInputTextarea rows="3"
                                formControlName="observacoes"></textarea>
                        </div>

                        <div formArrayName="itens">
                            <p-table [value]="itens.controls" dataKey="id">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th class="w-1px">Produto</th>
                                        <th class="w-1px">Possuía</th>
                                        <th class="w-1px text-center!">Entregue</th>
                                        <th class="w-1px text-center!">Vendido</th>
                                        <th class="w-1px text-center!">Retirado</th>
                                        <th class="w-1px text-center!">Possui agora</th>
                                        <th class="w-1px">Preço</th>
                                        <th class="w-1px text-center!">Valor bruto</th>
                                        <th class="w-1px text-center!">Desconto</th>
                                        <th class="w-1px text-center!">A pagar</th>
                                        <th class="w-1px"></th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-row let-i="rowIndex">
                                    <tr [formGroupName]="i">
                                        <td>
                                            <p-select formControlName="produtoId" name="produto" [options]="produtos"
                                                optionLabel="nome" optionValue="id" [filter]="true" filterBy="nome"
                                                [showClear]="true" placeholder="Selecione um produto"
                                                panelStyleClass="top-auto! bottom-full! origin-bottom! -translate-y-11"
                                                appendTo="body">
                                                <ng-template pTemplate="selectedItem" let-selectedOption>
                                                    <div class="flex items-center gap-2">
                                                        <div>{{ selectedOption?.nome }}</div>
                                                    </div>
                                                </ng-template>
                                                <ng-template pTemplate="item" let-produto>
                                                    <div class="flex items-center gap-2">
                                                        <div>{{ produto.nome }}</div>
                                                    </div>
                                                </ng-template>
                                            </p-select>
                                        </td>

                                        <td><input pInputText type="number" min="0" formControlName="possuia"
                                                (input)="recalc(i)" class="w-15 text-center" />
                                        </td>
                                        <td><input pInputText type="number" min="0" formControlName="entregue"
                                                (input)="recalc(i)" class="w-15 text-center" />
                                        </td>
                                        <td><input pInputText type="number" min="0" formControlName="vendido"
                                                (input)="recalc(i)" class="w-15 text-center" />
                                        </td>
                                        <td><input pInputText type="number" min="0" formControlName="retirado"
                                                (input)="recalc(i)" class="w-15 text-center" />
                                        </td>

                                        <td class="flex justify-center">
                                            <input pInputText formControlName="possuiAgora" readonly
                                                class="w-15 items-center text-center" />
                                        </td>

                                        <td class="text-center">
                                            {{getItem(i).get('preco')?.value | currency:'BRL':'symbol':'1.2-2'}}
                                        </td>

                                        <td class="text-center">
                                            {{getItem(i).get('valorBruto')?.value | currency:'BRL':'symbol':'1.2-2'}}
                                        </td>

                                        <td class="text-center">
                                            {{ getItem(i).get('desconto')?.value | currency:'BRL':'symbol':'1.2-2' }}
                                        </td>

                                        <td class="text-center">
                                            {{ getItem(i).get('valorPagar')?.value | currency:'BRL':'symbol':'1.2-2' }}
                                        </td>

                                        <td class="text-right">
                                            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger"
                                                type="button" (click)="removeItem(i)"
                                                [disabled]="somenteLeitura"></button>
                                        </td>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="footer">
                                    <tr>
                                        <td class="text-left font-medium">Totais</td>
                                        <td class="text-center!">{{ total('possuia') }}</td>
                                        <td class="text-center!">{{ total('entregue') }}</td>
                                        <td class="text-center!">{{ total('vendido') }}</td>
                                        <td class="text-center!">{{ total('retirado') }}</td>
                                        <td class="text-center!">{{ total('possuiAgora') }}</td>
                                        <td class="text-center!"></td>
                                        <td class="text-center!">{{ total('valorBruto') |
                                            currency:'BRL':'symbol':'1.2-2' }}</td>
                                        <td class="text-center!">{{ total('desconto') | currency:'BRL':'symbol':'1.2-2'
                                            }}</td>
                                        <td class="text-center!">{{ total('valorPagar') |
                                            currency:'BRL':'symbol':'1.2-2' }}</td>
                                        <td class="text-center!"></td>
                                    </tr>

                                </ng-template>
                            </p-table>
                        </div>

                        <div class="flex justify-self-start gap-2 mt-10">
                            <p-button severity="secondary" label="Fechar" class="p-button-text"
                                (onClick)="fecharDialogDetalhe()"></p-button>
                        </div>
                    </form>
                </p-dialog>

                <p-dialog [(visible)]="dialogEstoqueClienteAberto" [modal]="true"
                    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [header]="'Produtos em Posse'"
                    [maximizable]="true">
                    <div class="grid gap-3 min-h-fit">
                        <p-table [value]="estoqueClienteRows" [loading]="loadingEstoqueCliente"
                            [responsiveLayout]="'scroll'">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center!">Quantidade</th>
                                    <th class="text-center!">Preço</th>
                                    <th class="text-center!">Valor total</th>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="body" let-r>
                                <tr>
                                    <td>{{ r.produtoNome }}</td>
                                    <td class="text-center!">{{ r.quantidade }}</td>
                                    <td class="text-center!">{{ r.preco | currency:'BRL':'symbol':'1.2-2' }}</td>
                                    <td class="text-center!">{{ r.total | currency:'BRL':'symbol':'1.2-2' }}</td>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="4" class="text-center text-gray-500">
                                        Este cliente não possui produtos em estoque no momento.
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>

                        <div class="flex justify-self-start gap-2 mt-4">
                            <p-button severity="secondary" label="Fechar" class="p-button-text"
                                (onClick)="fecharDialogEstoqueCliente()"></p-button>
                        </div>
                    </div>
                </p-dialog>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>

    <ng-container *ngIf="!isAlteracao">
        <ng-container *ngTemplateOutlet="formCliente"></ng-container>
    </ng-container>
</p-card>

<ng-template #formCliente>
    <form class="w-full" [formGroup]="camposForm" (ngSubmit)="salvar()">
        <div class="mb-2">
            <label class="block font-semibold mb-1" for="nome">Nome</label>
            <input pInputText id="nome" formControlName="nome" placeholder="Ex. Booster" class="w-full" />
            <small class="text-red-500" *ngIf="isCampoInvalido('nome')">Campo obrigatório</small>
        </div>

        <div class="mb-2">
            <label class="block font-semibold mb-1" for="email">Email</label>
            <input pInputText id="email" formControlName="email" placeholder="Ex. BancaZapp@gmail.com" class="w-full" />
            <small class="text-red-500" *ngIf="isCampoInvalido('email')">Campo obrigatório</small>
        </div>

        <div class="mb-2">
            <label class="block font-semibold mb-1" for="telefone">Telefone</label>
            <input pInputText id="telefone" formControlName="telefone" placeholder="Ex. (11) 99999-9999"
                class="w-full" />
        </div>

        <div class="mb-2">
            <label class="block font-semibold mb-1">Localidade *</label>
            <p-dropdown [options]="localidades" optionLabel="nome" optionValue="id"
                placeholder="Selecione uma localidade" formControlName="localidadeId" class="w-full">
            </p-dropdown>
            <small *ngIf="isCampoInvalido('localidade')" class="text-red-500">Campo obrigatório</small>
        </div>

        <div class="mb-2">
            <label class="block font-semibold mb-1" for="endereco">Endereço</label>
            <input pInputText id="endereco" formControlName="endereco" placeholder="Ex. Rua das Flores, 123"
                class="w-full" />
        </div>

        <div class="mb-2">
            <label class="block font-semibold mb-1" for="comissao">Comissão padrão</label>
            <input pInputText id="comissao" type="number" formControlName="comissao" placeholder="Ex. 15"
                class="w-full" />
            <small class="text-red-500" *ngIf="isCampoInvalido('comissao')">Campo obrigatório</small>
        </div>

        <div class="mt-4 flex justify-end">
            <p-button type="submit" label="{{ botaoTexto }}" severity="success"></p-button>
        </div>
    </form>
</ng-template>
